#!/usr/bin/env bash
#MISE description="Update iac_config.wiz files with terraform backend bucket information"
#USAGE flag "--recreate" help="Recreate iac_config.wiz files even if they already exist"
#USAGE flag "--directories <dirs>" help="Comma-separated list of directories (defaults to same as init-backends)"

set -eo pipefail

TEMPLATE_DIR="$GIT_ROOT/templates"
TEMPLATE_FILE="$TEMPLATE_DIR/iac_config.wiz.template"
CONFIG_PATH="$GIT_ROOT/infrastructure/backend-config.json"
RECREATE=false

# shellcheck disable=SC2154
if [ "$usage_recreate" = "true" ]; then
  RECREATE="$usage_recreate"
  echo "Recreating iac_config.wiz files"
fi

if [[ ! -f $TEMPLATE_FILE ]]; then
  echo "Error: Template file not found at $TEMPLATE_FILE"
  exit 1
fi

if [[ ! -f $CONFIG_PATH ]]; then
  echo "Error: Backend config not found at $CONFIG_PATH"
  echo "Run mise run bootstrap-branch first."
  exit 1
fi

# Read configuration from backend-config.json
BUCKET=$(jq -r '.state.bucket' "$CONFIG_PATH")
REGION=$(jq -r '.state.region' "$CONFIG_PATH")
ENVIRONMENT=$(jq -r '.environment' "$CONFIG_PATH")

if [ -n "${usage_directories:-}" ]; then
  IFS=',' read -ra directories <<<"$usage_directories"
  echo "Using custom directories: ${directories[*]}"
else
  echo "No directories provided, using default directories"
  directories=(
    "infrastructure/backends"
    "infrastructure/shared/aws"
    "infrastructure/wiz/develop"
    "scenarios"
  )
fi

# Generate iac_config.wiz file for Wiz Code-to-Cloud mapping
generate_iac_config() {
  local dir="$1"
  local state_key="$2"

  local iac_config_file="$dir/iac_config.wiz"
  echo "Generating iac_config.wiz in $dir"

  # Replace placeholders in template
  sed -e "s|{{ENVIRONMENT}}|${ENVIRONMENT}|g" \
    -e "s|{{BUCKET}}|${BUCKET}|g" \
    -e "s|{{REGION}}|${REGION}|g" \
    -e "s|{{STATE_KEY}}|${state_key}|g" \
    "$TEMPLATE_FILE" >"$iac_config_file"
}

copy_iac_config() {
  local dir="$1"
  local config_file="$dir/iac_config.wiz"
  local rel_path
  rel_path=$(python3 -c "import os.path; print(os.path.relpath('$dir', '$GIT_ROOT'))")
  local state_key="$rel_path/terraform.tfstate"

  if [[ ! -f $config_file || $RECREATE == "true" ]]; then
    generate_iac_config "$dir" "$state_key"
  else
    # Generate to temp file and compare
    local temp_file
    temp_file=$(mktemp)
    sed -e "s|{{ENVIRONMENT}}|${ENVIRONMENT}|g" \
      -e "s|{{BUCKET}}|${BUCKET}|g" \
      -e "s|{{REGION}}|${REGION}|g" \
      -e "s|{{STATE_KEY}}|${state_key}|g" \
      "$TEMPLATE_FILE" >"$temp_file"

    if ! diff -q "$temp_file" "$config_file" >/dev/null 2>&1; then
      echo "iac_config.wiz in $dir differs from template, recreating"
      mv "$temp_file" "$config_file"
    else
      rm "$temp_file"
    fi
  fi
}

process_directory() {
  local dir="$1"

  if [[ ! -d $dir ]]; then
    return
  fi

  if [[ $dir == *"/modules/"* ]]; then
    return
  fi

  if [[ -f "$dir/backend.tf" ]]; then
    echo "Found backend.tf in $dir, checking iac_config.wiz file"
    copy_iac_config "$dir"
  fi

  for subdir in "$dir"/*; do
    if [[ -d $subdir ]]; then
      if [[ $subdir == *"/modules/"* ]] || [[ $subdir == *"/custom_controls/"* ]]; then
        continue
      else
        process_directory "$subdir"
      fi
    fi
  done
}

for base_dir in "${directories[@]}"; do
  full_path="$GIT_ROOT/$base_dir"
  process_directory "$full_path"
done

echo "âœ… Copied iac_config.wiz template to directories with backend.tf"
