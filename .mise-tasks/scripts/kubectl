#!/usr/bin/env bash
# kubectl wrapper - validates AWS credentials for EKS access
# Supports: env vars, AWS_PROFILE, SSO, IMDS, credential_process

real_kubectl=$(mise which kubectl 2>/dev/null || which kubectl)
real_aws=$(mise which aws 2>/dev/null || which aws)

# Validate AWS credentials (required for EKS auth)
if ! "$real_aws" sts get-caller-identity &>/dev/null; then
  echo "ERROR: No valid AWS credentials found (required for EKS)." >&2
  echo "  Supported methods:" >&2
  echo "    - Environment: AWS_ACCESS_KEY_ID + AWS_SECRET_ACCESS_KEY" >&2
  echo "    - Profile: AWS_PROFILE or --profile" >&2
  echo "    - SSO: aws sso login" >&2
  echo "    - 1Password: eval \"\$(mise run auth)\"" >&2
  exit 1
fi

"$real_kubectl" "$@"
