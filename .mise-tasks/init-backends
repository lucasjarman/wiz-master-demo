#!/usr/bin/env bash
#MISE description="Initialize Terraform directories with environment-specific backend"

#USAGE flag "--force-recreate" help="Removes .terraform directories and reinitializes the backend configuration"
#USAGE flag "--config-path <config-path>" help="Provide the path to the backend-config.json file"
#USAGE flag "--directories <dirs>" help="Comma-separated list of directories to run init-backends  in"
#USAGE flag "--parallel" help="Execute backend initialization in parallel"

set -eo pipefail

FORCE_RECREATE=false

# shellcheck disable=SC2154
if [ "$usage_force_recreate" = "true" ]; then
  echo "Force initializing backend configuration"
  FORCE_RECREATE=true
fi

if [ -n "${usage_config_path:-}" ]; then
  CONFIG_PATH=$usage_config_path
  echo "Using provided path $CONFIG_PATH"
else
  echo "No config path provided, attempting to find backend-config.json"

  if [ ! -f "$CONFIG_PATH" ]; then
    echo "Backend config not found at: $CONFIG_PATH"
    echo "Run tf-bootstrap-backend first."
    exit 1
  fi
  echo "Found backend config at $CONFIG_PATH"
fi

if [ -n "${usage_directories:-}" ]; then
  IFS=',' read -ra directories <<<"$usage_directories"
  echo "Using custom directories: ${directories[*]}"
else
  echo "No directories provided, using default directories"
  directories=(
    "infrastructure/shared/aws"
    "infrastructure/wiz/develop"
    "scenarios"
  )
fi

# Get backend configuration for the environment
BACKEND_CONFIG=$(jq .state "$CONFIG_PATH")
if [ "$BACKEND_CONFIG" = "null" ]; then
  echo "No backend configuration found for state"
  exit 1
fi

BUCKET=$(jq -r '.state.bucket' "$CONFIG_PATH")
REGION=$(jq -r '.state.region' "$CONFIG_PATH")

execute_init_serial() {
  echo "ðŸš€ Starting serial backend initialization..."

  for dir in "${directories[@]}"; do
    full_path="$GIT_ROOT/$dir"
    echo "ðŸš€ Processing $dir..."
    process_directory "$full_path"
    echo "âœ… Completed backend init for $dir"
  done

  echo "All serial backend initialization jobs completed!"
}

execute_init_parallel() {
  local max_jobs=5
  local pids=()

  echo "ðŸš€ Starting parallel backend initialization with up to $max_jobs jobs..."

  for dir in "${directories[@]}"; do
    while [[ ${#pids[@]} -ge $max_jobs ]]; do
      echo "â³ Max jobs ($max_jobs) running, waiting for completion..."

      wait

      local new_pids=()
      for pid in "${pids[@]}"; do
        if kill -0 "$pid" 2>/dev/null; then
          new_pids+=("$pid")
        fi
      done
      pids=("${new_pids[@]}")

      echo "ðŸ“Š Jobs remaining: ${#pids[@]}"
    done

    # Start new job
    echo "ðŸš€ Starting backend init for $dir..."
    (
      full_path="$GIT_ROOT/$dir"
      process_directory "$full_path" 2>&1 | awk -v prefix="[$dir]" '{print prefix " " $0}'
    ) &

    pids+=($!)
    echo "âœ… Started backend init for $dir (PID: $!, ${#pids[@]}/$max_jobs active)"

    sleep 1
  done

  echo "â³ Waiting for all remaining jobs to complete..."
  for pid in "${pids[@]}"; do
    echo "â³ Waiting for PID $pid..."
    wait "$pid"
    echo "âœ… PID $pid completed"
  done

  echo "All parallel backend initialization jobs completed!"
}

process_directory() {
  local dir="$1"

  # Skip if not a directory
  if [[ ! -d $dir ]]; then
    echo "Skipping non-directory: $dir"
    return
  fi

  if [[ $dir == *"/modules/"* ]]; then
    echo "Skipping modules directory: $dir"
    return
  fi

  if [[ -n $(find "$dir" -maxdepth 1 -name "*.tf") ]]; then
    local backend_exists=false
    local backend_changed=false
    if [[ -f "$dir/backend.tf" ]]; then
      backend_exists=true

      if ! grep -q "${BUCKET}" "$dir/backend.tf"; then
        backend_changed=true
        echo "Backend bucket has changed in $dir"
      fi

    fi

    local should_update=false

    if [[ $FORCE_RECREATE == "true" ]]; then
      should_update=true
    elif [[ $backend_exists == "false" ]]; then
      should_update=true
    elif [[ $backend_changed == "true" ]]; then
      should_update=true
    fi

    if [[ $should_update == "true" ]]; then
      echo "Creating backend.tf in $dir"

      local rel_path
      rel_path=$(python3 -c "import os.path; print(os.path.relpath('$dir', '$GIT_ROOT'))")
      STATE_PATH="$rel_path"

      cat >"$dir/backend.tf" <<EOF
terraform {
  backend "s3" {
  encrypt = true
  use_lockfile = true
  }
}
EOF

      cat >"$dir/backend.hcl" <<EOF
bucket = "${BUCKET}"
key    = "${STATE_PATH}/terraform.tfstate"
region = "${REGION}"
EOF
      echo "State file will be stored at: ${STATE_PATH}/terraform.tfstate"
      cd "$dir"
      if [[ $FORCE_RECREATE == "true" ]] || [[ $backend_changed == "true" ]]; then
        echo "Cleaning .terraform directory for a fresh start"
        rm -rf "$dir/.terraform" "$dir/.terraform.lock.hcl"
      fi
      terraform init -reconfigure
      cd "$GIT_ROOT"

    elif [[ $backend_exists == "true" && ! -f "$dir/backend.hcl" ]]; then
      echo "Building backend.hcl for backend.tf"
      cat >"$dir/backend.hcl" <<EOF
bucket = "${BUCKET}"
key    = "${STATE_PATH}/terraform.tfstate"
region = "${REGION}"
EOF
      echo "Running terraform init in $dir"
      cd "$dir"
      terraform init
      cd "$GIT_ROOT"
    else
      echo "Running terraform init in $dir"
      cd "$dir"
      terraform init
      cd "$GIT_ROOT"
    fi
  fi

  for subdir in "$dir"/*; do
    if [[ -d $subdir ]]; then
      if [[ $subdir == *"/modules/"* ]] || [[ $subdir == *"/custom_controls/"* ]]; then
        echo "Skipping module directory $subdir"
      else
        echo "Processing subdirectory $subdir"
        process_directory "$subdir"
      fi
    fi
  done
}

# shellcheck disable=SC2154
if [ "$usage_parallel" = "true" ]; then
  execute_init_parallel
else
  execute_init_serial
fi
