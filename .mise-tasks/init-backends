#!/usr/bin/env bash
#MISE description="Initialize Terraform directories with environment-specific backend"

#USAGE flag "--force-recreate" help="Removes .terraform directories and reinitializes"
#USAGE flag "--config-path <config-path>" help="Path to backend-config.json"
#USAGE flag "--directories <dirs>" help="Comma-separated list of directories to init"

set -eo pipefail

FORCE_RECREATE=false

# shellcheck disable=SC2154
if [ "$usage_force_recreate" = "true" ]; then
  echo "Force initializing backend configuration"
  FORCE_RECREATE=true
fi

# Determine config path
if [ -n "${usage_config_path:-}" ]; then
  CONFIG_PATH=$usage_config_path
  echo "Using provided path $CONFIG_PATH"
elif [ -z "${CONFIG_PATH:-}" ]; then
  echo "No config path provided and CONFIG_PATH not set"
  exit 1
fi

if [ ! -f "$CONFIG_PATH" ]; then
  echo "Backend config not found at: $CONFIG_PATH"
  echo "Run tf-bootstrap-backend first."
  exit 1
fi

# Determine directories to process
if [ -n "${usage_directories:-}" ]; then
  IFS=',' read -ra directories <<<"$usage_directories"
  echo "Using custom directories: ${directories[*]}"
else
  echo "No directories provided, using default directories"
  directories=(
    "infrastructure/shared/aws"
    "infrastructure/wiz/develop"
    "scenarios"
  )
fi

# Get backend configuration
BUCKET=$(jq -r '.state.bucket' "$CONFIG_PATH")
REGION=$(jq -r '.state.region' "$CONFIG_PATH")

if [ -z "$BUCKET" ] || [ "$BUCKET" = "null" ]; then
  echo "No bucket found in backend configuration"
  exit 1
fi

echo "Using bucket: $BUCKET, region: $REGION"

process_directory() {
  local dir="$1"

  # Skip if not a directory
  if [[ ! -d $dir ]]; then
    echo "Skipping non-directory: $dir"
    return
  fi

  # Skip module directories
  if [[ $dir == *"/modules/"* ]] || [[ $dir == *"/modules" ]]; then
    echo "Skipping modules directory: $dir"
    return
  fi

  # Process if directory contains .tf files
  if [[ -n $(find "$dir" -maxdepth 1 -name "*.tf" 2>/dev/null) ]]; then
    echo "Processing $dir..."

    local rel_path
    rel_path=$(python3 -c "import os.path; print(os.path.relpath('$dir', '$GIT_ROOT'))")
    
    # Create backend.tf
    cat >"$dir/backend.tf" <<EOF
terraform {
  backend "s3" {
    encrypt      = true
    use_lockfile = true
  }
}
EOF

    # Create backend.hcl
    cat >"$dir/backend.hcl" <<EOF
bucket = "${BUCKET}"
key    = "${rel_path}/terraform.tfstate"
region = "${REGION}"
EOF

    echo "Created backend files for $dir (state key: ${rel_path}/terraform.tfstate)"

    # Run terraform init
    cd "$dir"
    if [[ $FORCE_RECREATE == "true" ]]; then
      echo "Cleaning .terraform directory for fresh start"
      rm -rf .terraform .terraform.lock.hcl
    fi
    terraform init -reconfigure -backend-config=backend.hcl
    cd "$GIT_ROOT"
    
    echo "âœ… Completed backend init for $dir"
  fi

  # Recurse into subdirectories
  for subdir in "$dir"/*; do
    if [[ -d $subdir ]]; then
      process_directory "$subdir"
    fi
  done
}

echo "ðŸš€ Starting backend initialization..."

for dir in "${directories[@]}"; do
  full_path="$GIT_ROOT/$dir"
  echo "ðŸ“ Processing $dir..."
  process_directory "$full_path"
done

echo "âœ… All backend initialization completed!"

