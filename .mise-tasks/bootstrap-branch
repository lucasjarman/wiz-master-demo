#!/usr/bin/env bash
#MISE description="Bootstraps the backend state infrastructure"
#MISE dir="infrastructure/backends"

#USAGE flag "--directories <dirs>" help="Comma-separated list of directories to run init-backends  in"
#USAGE flag "--branch <branch>" help="Branch to use for the environment"
#USAGE flag "--hocus-pocus" help="Bypass safety checks for running on main or staging branches locally"
#USAGE flag "--force" help="Force overwrite of existing backend-config.json (use with caution)"

set -eo pipefail

is_ci() {
  [[ "${GITHUB_ACTIONS:-}" == "true" || "${CI:-}" == "true" ]]
}

# Determine environment
if [ -n "${usage_branch:-}" ]; then
  BRANCH="$usage_branch"
else
  BRANCH=$(git rev-parse --abbrev-ref HEAD)
fi

if [[ "${BRANCH}" == "main" ]]; then
  TF_VAR_environment="prod"
elif [[ "${BRANCH}" == "staging" ]]; then
  TF_VAR_environment="staging"
else
  BRANCH=$(echo "$BRANCH" | tr '/' '-' | tr '[:upper:]' '[:lower:]')
  TF_VAR_environment="dev"
fi

if [[ -n "${usage_hocus_pocus:-}" ]]; then
  hocus_pocus="true"
else
  hocus_pocus="false"
fi

# Check if backend-config.json already exists (protect against accidental overwrite)
BACKEND_CONFIG="../backend-config.json"
if [[ -f "$BACKEND_CONFIG" ]] && [[ -z "${usage_force:-}" ]]; then
  echo ""
  echo "[ERROR]: âš ï¸  backend-config.json already exists!"
  echo "[ERROR]: This file contains critical state configuration. Overwriting it could break existing deployments."
  echo ""
  echo "Current configuration:"
  cat "$BACKEND_CONFIG" | jq -r '"  Bucket: \(.state.bucket)\n  Region: \(.state.region)\n  Environment: \(.environment)\n  Branch: \(.branch)"' 2>/dev/null || cat "$BACKEND_CONFIG"
  echo ""
  echo "[INFO]: If you want to use the existing configuration, run:"
  echo "        mise run init-backends --directories <dirs>"
  echo ""
  echo "[INFO]: If you really want to bootstrap a NEW backend (and overwrite existing config), run:"
  echo "        mise run bootstrap-branch --force --directories <dirs>"
  echo ""
  exit 1
fi

# Check if valid credentials exist
if ! aws sts get-caller-identity &>/dev/null; then
  echo "[Error]: Invalid or Missing AWS Credentials.  Please configure valid AWS credentials." >&2
  exit 1
fi

echo "[INFO]: Working with environment: ${TF_VAR_environment:-}"
echo "[INFO]: Your branch is currently set to ${BRANCH:-}"

export TF_VAR_environment BRANCH
SSM_PARAM_NAME="/demo/terraform/backend/$BRANCH/config"

if ! is_ci; then
  echo "[INFO]: â„¹ï¸ Runtime Environment: Local Machine â„¹ï¸ "

  if [[ "${BRANCH:-}" == "main" || "${BRANCH:-}" == "staging" ]]; then
    echo "[WARN]:âš ï¸ You are attempting to run this script on the '$BRANCH' branch locally."
    echo "[WARN]:âš ï¸ This is discouraged to prevent accidental changes to main or staging environments."
    echo "[INFO]:ðŸ¤” If you are developing locally, you probably meant to switch to a new feature branch first"
    echo "[WARN]:ðŸ›‘ If you really want to bootstrap to main or staging, please confirm this is intended"
    echo "[WARN]: Your current user in the AWS Account with the state backend is: $(aws sts get-caller-identity --query Arn --output text)"
    echo ""
    if [[ "$hocus_pocus" != "true" ]]; then
      echo "[WARN]: If this is intended, rerun the script with the password."
      echo "[ERROR]: Exiting script."
      exit 1
    else
      echo "ðŸ§™ðŸ§™ðŸ§™ðŸ§™ðŸ§™ðŸ§™ðŸ§™ðŸ§™ðŸ§™ðŸ§™ðŸ§™ðŸ§™"
      echo "[ðŸ”¥]: A wizard is never late, nor are they early, they ship to $(echo "$BRANCH" | tr '[:lower:]' '[:upper:]') precisely when they mean to..."
      echo "ðŸ§™ðŸ§™ðŸ§™ðŸ§™ðŸ§™ðŸ§™ðŸ§™ðŸ§™ðŸ§™ðŸ§™ðŸ§™ðŸ§™"
    fi
  fi
else
  echo "[INFO]: â„¹ï¸ Runtime Environment: Pipeline â„¹ï¸ "
fi

if aws ssm get-parameter --name "$SSM_PARAM_NAME" &>/dev/null; then
  echo ""
  echo "[INFO]: ðŸ” Found existing backend configuration in Parameter Store"
  aws ssm get-parameter --name "$SSM_PARAM_NAME" --query 'Parameter.Value' --output text >../backend-config.json

  # Extract values for later use
  BUCKET=$(jq -r '.state.bucket' ../backend-config.json)
  REGION=$(jq -r '.state.region' ../backend-config.json)
  RANDOM_ID=$(jq -r '.random_prefix_id' ../backend-config.json)

  cat >backend.tf <<EOF
terraform {
  backend "s3" {
key            = "bootstrap/terraform.tfstate"
use_lockfile   = true
encrypt        = true
}
}
EOF
  echo "[INFO]: Reconfiguring backend"

  cat >backend.hcl <<EOF
bucket         = "${BUCKET}"
region         = "${REGION}"
EOF
  terraform init -reconfigure

else
  echo ""
  echo "[WARN]: ðŸš€ No existing backend configuration found for $SSM_PARAM_NAME. Bootstrapping new backend."
  if ! is_ci && { [[ "$BRANCH" == "main" ]] || [[ "$BRANCH" == "staging" ]]; }; then
    echo "[WARN]: âš ï¸âš ï¸âš ï¸âš ï¸ Sleeping for 10 seconds to allow for cancellation if this is unintended. Hit CTRL-C twice to stop the script. âš ï¸âš ï¸âš ï¸âš ï¸"
    sleep 10
  else
    sleep 2
  fi
  echo ""
  echo "[INFO]: Creating new backend resources in $TF_VAR_environment environment."

  # Clean .terraform directory and any backend.tf file
  rm -rf .terraform .terraform.lock.hcl backend.tf

  # Initialize and create backend resources with local state first
  terraform init -reconfigure
  TF_VAR_branch=$BRANCH terraform apply -auto-approve

  # Get outputs for the new resources
  terraform output -json backend_config >../backend-config.json
  RANDOM_ID=$(terraform output -raw random_id)

  # Update the JSON with environment info
  jq --arg branch "$BRANCH" \
    --arg env "$TF_VAR_environment" \
    --arg random_prefix "$RANDOM_ID" \
    '. += {"environment": $env, "branch": $branch, "random_prefix_id": $random_prefix}' \
    ../backend-config.json >temp.json && mv temp.json ../backend-config.json

  # Get values for later use
  BUCKET=$(jq -r '.state.bucket' ../backend-config.json)
  REGION=$(jq -r '.state.region' ../backend-config.json)

  cat >backend.tf <<EOF
terraform {
  backend "s3" {
key            = "bootstrap/terraform.tfstate"
use_lockfile   = true
encrypt        = true
}
}
EOF
  echo "[INFO]: Reconfiguring backend"

  cat >backend.hcl <<EOF
bucket         = "${BUCKET}"
region         = "${REGION}"
EOF

  # Migrate the local state to the S3 backend
  echo "[INFO]: Migrating bootstrap state to the bucket it just created..."
  terraform init -force-copy

  # Store parameters in SSM for future use
  aws ssm put-parameter \
    --name "$SSM_PARAM_NAME" \
    --type "String" \
    --value "$(cat ../backend-config.json)" \
    --overwrite

  echo "[INFO]: Stored backend configuration in Parameter Store at $SSM_PARAM_NAME"
fi

echo "Backend configuration complete:"
echo "  Environment: $TF_VAR_environment"
echo "  Bucket: $BUCKET"
echo "  Region: $REGION"

echo "[INFO]: Bootstrap complete! Now running 'mise run init-backends' to configure backend.tf files in all directories."

if ! is_ci; then
  echo "[INFO]: Detected running locally, resetting backends"
  echo "[INFO]: Removing all previous backend.tf files folders."
  if ! mise run reset-backends; then
    echo "[ERROR]: Failed to reset backends. Please check the logs."
    exit 1
  fi
fi

if [ -n "${usage_directories:-}" ]; then
  echo "[INFO]: Creating and reinitializing backend.tf files with custom directories $usage_directories"
  mise run init-backends --directories "$usage_directories"
  mise run create-wiz-iac-files --directories "$usage_directories"
else
  echo "[INFO]: Creating and reinitializing backend.tf files in all directories"
  mise run init-backends
  mise run create-wiz-iac-files
fi
