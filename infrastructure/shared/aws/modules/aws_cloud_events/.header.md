# wiz-aws-cloud-events-terraform-module

A Terraform module to integrate AWS CloudTrail logs with Wiz.

Supported Configurations:

**A new SQS queue will always be created.**

- CloudTrail Notifications
  - New SNS Topic
    - CloudTrail Notification -> SNS Topic (New) -> SQS Queue
      - _CloudTrail notifications must be configured to the new SNS topic once created_
  - Existing SNS Topic
    - CloudTrail Notification -> SNS Topic (Existing) -> SQS Queue
      - _Existing CloudTrail notification SNS topic must allow subscriptions from the new SQS queue_
- S3 Bucket Notifications
  - New Bucket Notification
    - S3 Bucket Notification (New) -> SNS Topic (New) -> SQS Queue
    - S3 Bucket Notification (New) -> SQS Queue
  - Existing Bucket Notification
    - S3 Bucket Notification (Existing) -> SNS Topic (Existing) -> SQS Queue

The module also aims to encrypt all notifications in transit using AWS CMKs.
This behavior can be modified by changing the `sns_topic_encryption_enabled` and/or `sqs_encryption_enabled` variables.
Users can also "bring their own key" and provide the ARNs of their CMKs as the `sns_topic_encryption_key_arn` and/or `sqs_encryption_key_arn` variables.

In cases where CloudTrail logs are encrypted with a customer managed key, you may also need to add a statement to your KMS key policy in order for Wiz to properly decrypt the log files. An example statement for the key policy is provided below.

```json
{
  "Sid": "Allow Wiz role to decrypt CloudTrail files",
  "Effect": "Allow",
  "Principal": {
    "AWS": "<WIZ_ROLE_ARN>"
  },
  "Action": "kms:Decrypt",
  "Resource": "<CLOUDTRAIL_ENCRYPTION_KEY_ARN>",
  "Condition": {
    "Null": {
      "kms:EncryptionContext:aws:cloudtrail:arn": "false"
    }
  }
}
```

## Known Issues

A [bug](https://github.com/hashicorp/terraform/issues/34014) in Terraform variable validation was introduced which can lead to state file incompatibility between specific versions. If a Terraform apply is executed using version `1.6.0` or higher, then the state file will become incompatible with the following versions:

- Terraform 1.3 prior to 1.3.10
- Terraform 1.4 prior to 1.4.7
- Terraform 1.5 prior to 1.5.7

_Versions before 1.3.0 and after 1.6.0 are unaffected._

To resolve this issue, use a version of Terraform which contains the fix for this issue.
